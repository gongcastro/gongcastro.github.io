---
title: renv (o cómo usar paquetes de R sin ataques de pánico)
author: Gonzalo Garcia-Castro
date: '2022-02-27'
slug: renv
categories:
  - rstats
  - r
tags:
  - r
  - reproducibility
comments: no
images: ~
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<p>A veces necesitamos instalar versiones diferentes del mismo paquete de R en proyectos diferentes. El paquete <strong>{renv}</strong> nos permite <strong>almacenar los paquetes de R de cada proyecto de forma independiente</strong>, evitando posibles conflictos entre proyectos. De paso, incrementará la <strong>reproducibilidad computacional</strong> de nuestro código.</p>
<p><img src="/img/containers.jpg" /></p>
<div id="el-problema" class="section level1">
<h1>El problema</h1>
<p>Ponte en la siguiente situación: tienes entre manos un proyecto de R que necesita varios paquetes. Cada uno de estos paquetes depende, a su vez, de terceros paquetes. De hecho, dos paquetes pueden depender del mismo paquete, o incluso de <strong>versiones diferentes</strong> del mismo paquete. Si hay mala suerte, una de las versiones no será lo suficientemente reciente como para funcionar correctamente con ambos paquetes. Resultado: uno de los dos paquetes no funcionará.</p>
<div class="figure">
<img src="/img/panic.gif" alt="" />
<p class="caption">Usuarie de R promedio después de tirar dos horas a la basura intentando instalar los paquetes que necesita para trabajar en un proyecto de R que no tocaba desde hacía cuatro meses.</p>
</div>
<p>Este problema se extiende al caso de que necesitemos versiones diferentes del mismo paquete en proyectos de R diferentes en los que estamos trabajando de forma simultánea en el mismo ordenador. Para hacerlos funcionar necesitaríamos instalar de nuevo la versión correspondiente del mismo paquete cada vez que cambiemos de proyecto.</p>
</div>
<div id="instalando-paquetes-de-r" class="section level1">
<h1>Instalando paquetes de R</h1>
<p>En resumidas cuentas, cada vez que instalamos o actualizamos un paquete de R, lo hacemos para todos nuestros proyectos de R de forma <em>global</em>. Esto se debe a que por defecto R busca todos los paquete de R en la misma carpeta. Para ver dónde instala R tus paquetes puedes ejecutar el siguiente comando:</p>
<pre><code>.libPaths()</code></pre>
<p>Este comando te mostrará el directorio o <strong>directorios donde R instala sus paquetes por defecto</strong>. Si hay más de un directorio significa que, en caso de que no sea posible encontrar un paquete en el primer directorio, R lo buscará en el segundo, tercero, etc., hasta que te devuelva un error indicando que no has instalado ese paquete.</p>
<p>Si accedes al primer directorio que muestra <code>.libPaths()</code> verás que <strong>cada paquete tiene una carpeta</strong>. Cada carpeta incluye el código de R, los datos y la documentación asociada a cada paquete (entre otras cosas). Cada vez que instalamos o actualizamos un paquete, se crea o reemplaza su carpeta correspondiente en nuestro directorio, es decir, en nuestra “biblioteca global” de paquetes de R.</p>
<div class="figure">
<img src="/img/boxes.jpeg" alt="" />
<p class="caption">Así es como tienes tu carpeta de paquetes de R. Que lo sé yo. Que te he visto. Vergüenza me daría a mí.</p>
</div>
<p>Hemos visto que esto no es ideal. ¿No será mejor tener una carpeta diferente para cada proyecto en la que instalamos sus paquetes de forma independente, sin afectar a los paquetes de otros proyectos? Sí. De hecho este procedimiento es estándar en otros lenguajes de programación como JavaScript<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> o Julia <a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>. Existe un paquete de R que nos permite hacer esto: <a href="https://github.com/rstudio/renv/"><strong>renv</strong></a>. Veamos cómo funciona.</p>
<iframe width="560" height="315" src="https://www.youtube.com/watch?v=yjlEbIDevOs" frameborder="0" allowfullscreen>
</iframe>
</div>
<div id="usando-renv" class="section level1">
<h1>Usando renv</h1>
<p>Primero hay que <strong>instalar renv</strong>. Como está incluido en el CRAN, podemos hacerlo usando <code>install.packages()</code>:</p>
<pre class="r"><code>install.packages(&quot;renv&quot;)</code></pre>
<p>Ahora abrimos una sesión de R en la carpeta de nuestro proyecto. Digamos que nuestra carpeta tiene la siguiente estructura:</p>
<pre><code>data
 |-some-data.csv
docs
 |-index.Rmd
 |-index.html
R
 |-main.R
 |-functions.R
.Rprofile</code></pre>
<p>Así es la estructura de la mayoría de carpetas de mis proyectos de R. Tiene su razón de ser, pero eso es material para otro post. Lo importante es cómo cambiará esta estructura en unos momentos. La <a href="https://rstudio.github.io/renv/articles/renv.html">documentación de renv</a> incluye los pasos para usar renv, pero explicaré los principales. Primero inicializaremos renv en nuestra consola de R:</p>
<pre class="r"><code>renv::init()</code></pre>
<p>Esto creará una carpeta (<code>renv</code>) y un archivo (<code>renv.lock</code>) nuevos en nuestro directorio:</p>
<pre><code>.Rprofile
data
    |-some-data.csv
docs
    |-index.Rmd
    |-index.html
R
    |-main.R
    |-functions.R
renv
    |-.gitignore
    |-activate.R
    |-library
        |-...
    |-local
        |-...
    |-settings.dcf
renv.lock</code></pre>
<p>No necesitaremos modificar ni consultar nunca ningunos de los archivos creados, pero vamos a curiosear un poco. Al usar <code>init()</code>, renv ha echado un vistazo a los scripts de R de la carpeta (achivos con la extensión .R, como <code>main.R</code> y <code>functions.R</code>), y ha detectado los paquetes que necesita nuestro código para ejecutarse (puedes consultar las dependencias de tu proyecto usando <code>renv::dependencies()</code>). Por ejemplo, si <code>main.R</code> incluye <code>library(dplyr)</code> o <code>dplyr::mutate()</code>, detectará el paquete dplyr como una dependencia.</p>
<div class="figure">
<img src="/img/detector.gif" alt="" />
<p class="caption">renv detectando tus dependencias.</p>
</div>
<p>A continuación, renv ha instalado todas los paquetes necesarios en <code>renv/library/</code>. Si comparas esa carpeta con el directorio mostrado en <code>.libPaths()</code> (como hicimos hace un momento), verás que ambas carpetas son muy parecidas. Eso es porque ahora R buscará los paquetes que necesites en esa carpeta, y no en la “biblioteca global” de paquetes de R. Esa es la magia de renv: podrás instalar y actualizar paquetes de R de forma independiente para cada uno de tus proyectos. Para instalar nuevos paquetes deberás hacerlo usando la función <code>renv::install()</code>. Por ejemplo:</p>
<pre class="r"><code>renv::install(&quot;tidyr&quot;)</code></pre>
<p>Esta función es el equivalente a <code>install.packages()</code> en renv. esta función asumirá que el paquete que quieres se encuentra en CRAN y será allí donde lo buscará. Si el paquete que quieres instalar se eneucntra alojado en otro sitio (o quieres instalar una versión experimental del mismo, en un repositorio de GitHub, por ejemplo), puedes indicar el repositorio de la siguiente forma:</p>
<pre class="r"><code>renv::install(&quot;crsh/papaja&quot;)</code></pre>
<p>Si echas un vistazo a <code>renv.lock</code> verás que incluye una lista de todas las dependencias de tu proyecto, en un formato un poco raro, con muchos paréntesis. No necesitas entender este archivo, sólo que sigue un formato parecido al que usan otros leguajes de programación para hacer lo mismo. Es el equivalente al archivo <code>package-lock.json</code> de un proyecto de JavaScript o al archivo <code>Manifest.toml</code> de un proyecto de Julia. Si te fijas, verás que simplemente incluye información mínima para cada paquete: nombre, versión, origen y un código que lo identifica. Por ejemplo, el <code>renv.lock</code> de nuestro proyecto incluye lo siguiente:</p>
<pre class="json"><code>{
  &quot;R&quot;: {
    &quot;Version&quot;: &quot;4.0.4&quot;,
    &quot;Repositories&quot;: [
      {
        &quot;Name&quot;: &quot;CRAN&quot;,
        &quot;URL&quot;: &quot;https://cran.rstudio.com&quot;
      }
    ]
  },
  &quot;Packages&quot;: {
    &quot;dplyr&quot;: {
      &quot;Package&quot;: &quot;dplyr&quot;,
      &quot;Version&quot;: &quot;1.0.8&quot;,
      &quot;Source&quot;: &quot;Repository&quot;,
      &quot;Repository&quot;: &quot;CRAN&quot;,
      &quot;Hash&quot;: &quot;ef47665e64228a17609d6df877bf86f2&quot;
    },
    &quot;papaja&quot;: {
      &quot;Package&quot;: &quot;papaja&quot;,
      &quot;Version&quot;: &quot;0.1.0.9997&quot;,
      &quot;Source&quot;: &quot;GitHub&quot;,
      &quot;RemoteType&quot;: &quot;github&quot;,
      &quot;RemoteHost&quot;: &quot;api.github.com&quot;,
      &quot;RemoteUsername&quot;: &quot;crsh&quot;,
      &quot;RemoteRepo&quot;: &quot;papaja&quot;,
      &quot;RemoteRef&quot;: &quot;master&quot;,
      &quot;RemoteSha&quot;: &quot;a231c3628ccf24359cc17f11a5bbc743e3fed920&quot;,
      &quot;Remotes&quot;: &quot;tidymodels/broom&quot;,
      &quot;Hash&quot;: &quot;3df0637229690f807616c46d3ff77113&quot;
    },
    &quot;tidyr&quot;: {
      &quot;Package&quot;: &quot;tidyr&quot;,
      &quot;Version&quot;: &quot;1.2.0&quot;,
      &quot;Source&quot;: &quot;Repository&quot;,
      &quot;Repository&quot;: &quot;CRAN&quot;,
      &quot;Hash&quot;: &quot;d8b95b7fee945d7da6888cf7eb71a49c&quot;
    },
  }
}</code></pre>
<p>Una ventaja enorme de usar renv es que si descargas o copias y pegas esta carpeta en un ordenador diferente (en el que posiblemente tengas una colección de paquetes diferente a la del ordenador donde trabajaste con el proyecto por última vez), <strong>renv podrá consultar este archivo para instalar por tí los paquetes necesarios en sus versiones correspondientes</strong>. Esto se puede hacer usando el comando:</p>
<pre class="r"><code>renv::restore()</code></pre>
<p><strong><em>Importante</em></strong>: cuando instales nuevos paquetes usando <code>renv::install()</code>, el archivo <code>renv.lock</code> no se actualizará de forma automática. Para incluir los nuevos paquetes en este archivo, tendremos que usar el siguiente comando:</p>
<pre class="r"><code>renv::snapshot()</code></pre>
<p>Como podrás imaginar, poder instalar los paquetes que necesita un proyecto en su versión adecuada resuelve uno de los problemas más frecuentes que amenazan la <strong>reproducibilidad computacional</strong> de nuestros proyectos.</p>
<div class="figure">
<img src="/img/happy.gif" alt="" />
<p class="caption">Imaginando un mundo donde todo el mundo se preocupa lo suficiente por la reproducibilidad computacional de sus proyectos.</p>
</div>
</div>
<div id="conclusiones" class="section level1">
<h1>Conclusiones</h1>
<p>Te recomiendo empezar a usar <strong>renv</strong> en algún proyecto “de juguete” con el que puedas experimentar, e ir poco a poco incorporando esta rutina en tus proyectos por el bien de tu salud mental y de la de les demás. :smile:</p>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Echa un vistazo a este post de Nikola Đuza: <a href="https://blog.appsignal.com/2020/04/09/ride-down-the-javascript-dependency-hell.html">Ride Down Into JavaScript Dependency Hell</a><a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>Echa un vistazo a este post de Bogumił Kamiński: <a href="https://bkamins.github.io/julialang/2020/05/18/project-workflow.html">My practices for managing project dependencies in Julia</a><a href="#fnref2" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
